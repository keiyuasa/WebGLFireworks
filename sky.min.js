var q=new qtnIV,qt=q.identity(q.create()),loc_fireworks=null,stride_fireworks=null,loc_ground=null,stride_ground=null,mouseOn=!1,mx,my,prg_fireworks=null,pointSize=3;function mouseDown(d){mouseOn=!0;mx=d.clientX;my=d.clientY}function mouseUp(d){mouseOn=!1}function mouseMove(d){if(mouseOn){var b=c.width,g=c.height,g=1/Math.sqrt(b*b+g*g),b=mx-d.clientX;d=my-d.clientY;var e=Math.sqrt(b*b+d*d),g=2*e*Math.PI*g;1!=e&&(e=1/e,b*=e/4,d*=e/4);q.rotate(g,[b,d,0],qt)}}
onload=function(){function d(b){var d=document.getElementById(b);if(d){switch(d.type){case "x-shader/x-vertex":b=e.createShader(e.VERTEX_SHADER);break;case "x-shader/x-fragment":b=e.createShader(e.FRAGMENT_SHADER);break;default:return}e.shaderSource(b,d.text);e.compileShader(b);if(e.getShaderParameter(b,e.COMPILE_STATUS))return b;alert(e.getShaderInfoLog(b))}}function b(b){var d=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,d);e.bufferData(e.ARRAY_BUFFER,new Float32Array(b),e.STATIC_DRAW);e.bindBuffer(e.ARRAY_BUFFER,
null);return d}function g(b,d,g){for(var h in b)e.bindBuffer(e.ARRAY_BUFFER,b[h]),e.enableVertexAttribArray(d[h]),e.vertexAttribPointer(d[h],g[h],e.FLOAT,!1,0,0)}c=document.getElementById("canvas");c.width=800;c.height=800;c.addEventListener("mousedown",mouseDown);c.addEventListener("mouseup",mouseUp);c.addEventListener("mousemove",mouseMove,!0);var e=c.getContext("webgl")||c.getContext("experimental-webgl");e.getParameter(e.ALIASED_POINT_SIZE_RANGE);var h=d("vs"),l=d("fs");prg_fireworks=function(b,
d){var g=e.createProgram();e.attachShader(g,b);e.attachShader(g,d);e.linkProgram(g);if(e.getProgramParameter(g,e.LINK_STATUS))return e.useProgram(g),g;alert(e.getProgramInfoLog(g))}(h,l);loc_fireworks=[];loc_fireworks[0]=e.getAttribLocation(prg_fireworks,"position");loc_fireworks[1]=e.getAttribLocation(prg_fireworks,"color");loc_ground=[];loc_ground[0]=e.getAttribLocation(prg_fireworks,"position");loc_ground[1]=e.getAttribLocation(prg_fireworks,"color");stride_fireworks=[3,4];stride_ground=[3,4];
var m=[],p=[],r=[];r[0]=e.getUniformLocation(prg_fireworks,"mvpMatrix");r[1]=e.getUniformLocation(prg_fireworks,"pointSize");var t=[];t[0]=e.getUniformLocation(prg_fireworks,"mvpMatrix");t[1]=e.getUniformLocation(prg_fireworks,"pointSize");var k=new matIV,n=k.identity(k.create()),u=k.identity(k.create()),w=k.identity(k.create()),v=k.identity(k.create()),x=k.identity(k.create());k.identity(k.create());e.enable(e.DEPTH_TEST);e.depthFunc(e.LEQUAL);var y=0,z=0;(function(){position=[];color=[];m=[];p=
[];e.clearColor(0,0,0,1);e.clearDepth(1);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var d=k.identity(k.create());q.toMatIV(qt,d);var h=2*Math.PI*y/2E3;2E3<=y++&&(y=0);var l=2*Math.PI*z/2020;2020<=z++&&(z=0);h=50*Math.cos(h);l=50*Math.sin(l);k.lookAt([h,l,0],[0,0,0],[0,0,-1],u);k.multiply(u,d,u);k.perspective(45,c.width/c.height,.1,100,w);k.multiply(w,u,v);set_position(position,color);a=b(position);h=b(color);g([a,h],loc_fireworks,stride_fireworks);k.identity(n);k.rotate(n,Math.PI/2,[1,0,0],n);
k.scale(n,[3,3,1],n);k.multiply(v,n,x);e.uniformMatrix4fv(r[0],!1,x);e.uniform1f(r[1],3);e.drawArrays(e.POINTS,0,position.length/3);e.flush();d=set_position_ground(m,p);h=b(m);l=b(p);g([h,l],loc_ground,stride_ground);e.uniformMatrix4fv(t[0],!1,x);e.uniform1f(t[1],3);e.drawArrays(e.TRIANGLE_STRIP,0,m.length/3);e.flush();d&&(m=[],p=[]);setTimeout(arguments.callee,20)})()};function color(){this.green=this.red=216;this.blue=48}color.prototype.create=function(d,b,g){this.red=d;this.green=b;this.blue=g};var colors=[];colors[0]=new color;colors[0].create(255,41,33);colors[1]=new color;colors[1].create(249,255,84);colors[2]=new color;colors[2].create(32,255,32);colors[3]=new color;colors[3].create(16,32,255);colors[4]=new color;colors[4].create(255,32,240);colors[4]=new color;colors[4].create(255,32,240);colors[5]=new color;colors[5].create(51,194,255);colors[6]=new color;
colors[6].create(255,194,51);colors[7]=new color;colors[7].create(207,207,207);function Cube(){this.px=[];this.py=[];this.pz=[];this.create=function(){for(var d=0,b=0;2>b;b++)for(var g=0;2>g;g++)for(var e=0;2>e;e++){var h=-1+2*g,l=-1+2*e;this.px[d]=(-1+2*b)/4;this.py[d]=h/4;this.pz[d]=l/1;d++}this.numStars=d}}
function Sphere(){this.px=[];this.py=[];this.pz=[];var d,b,g,e,h,l,m;this.create=function(p,r){var t=2*p-1,k=0,n,u,w=Math.PI;for(n=1;n<t;n++)k+=p*r*Math.sin(Math.PI*n/(t+1));n=1;for(k=0;n<=t;n++){b=Math.PI*n/(t+1);l=Math.cos(b);m=Math.sin(b);u=Math.floor(3*p*Math.sin(Math.PI*n/(t+1)));for(var v=0;v<u;v++)d=2*Math.PI*v/u,this.px[k]=r*m*Math.cos(d)*p,this.py[k]=r*m*Math.sin(d)*p,this.pz[k]=r*l*p,k++}g=Math.random()*Math.PI*2;b=Math.random()*Math.PI*2;e=Math.cos(g);h=Math.sin(g);l=Math.cos(b);m=Math.sin(b);
for(n=0;n<k;n++)t=this.px[n],u=this.py[n]*e-this.pz[n]*h,v=this.py[n]*h+this.pz[n]*e,this.px[n]=t*l-v*m,this.py[n]=u,this.pz[n]=(t*m+v*l)*w;this.numStars=k}}function shell(){this.g=this.r=255;this.b=128;this.time=0}
function shell(d,b,g,e,h,l,m,p){this.r=64;this.g=255;this.b=64;this.ox=d;this.oy=b;this.oz=g;this.start=l;this.end=m;this.life=p;this.time=l;this.gravity=8E-5;this.shooters=[];d=new Sphere;d.create(e,h);this.numShooter=d.numStars;this.position=[];this.color=[];this.sphere=new Sphere;this.sphere.create(e,h);this.num=this.sphere.numStars;this.time=0;this.active=!0}shell.prototype.setTime=function(d){this.time=d};shell.prototype.setColors=function(d,b,g){this.r=d;this.g=b;this.b=g};
shell.prototype.draw=function(d,b){if(!(this.time<this.start||this.time>this.end))for(var g=this.time-this.start,e=(this.end-this.time)/(.8*(this.end-this.start))/256,h=0;h<this.num;h++){d[pindex++]=this.ox+this.sphere.px[h]*g;d[pindex++]=this.oy+(this.sphere.py[h]+this.gravity*g)*g;d[pindex++]=this.oz+this.sphere.pz[h]*g;var l=this.r*e,m=this.g*e,p=this.b*e;b[cindex++]=l;b[cindex++]=m;b[cindex++]=p;b[cindex++]=1}};
shell.prototype.proceed=function(){this.time++;this.time>=this.life?(this.active=!1,this.time=0):this.active=!0;return this.active};shell.prototype.launcher=function(d,b,g,e,h,l,m,p,r){this.g=this.r=255;this.b=128;this.x=d;this.y=b;this.z=g;this.start=m;this.end=p;this.life=r;this.shooters=[];this.num=5;for(d=0;d<this.num;d++)this.sphere.px[d]=e*(.5+d/2/this.numShooter),this.sphere.py[d]=h*(.5+d/2/this.numShooter),this.sphere.pz[d]=l*(.5+d/2/this.numShooter);this.time=0;this.active=!0};
var pindex,cindex,num=24,theSet=[],life=240,diff=life/num,launcher_length=80,shell_length=160,launcher_start=0,shell_start=launcher_length-diff,rad=2,rnd=2,size=4,diff=60,vel=.007,gravity=4E-4,lx=[-3,0,3],ly=[3,3,3],lz=[0,0,0],lastx=[0,0,0],lasty=[0,0,0],lastz=[0,0,0],level=[0,0,0],lindex=0,findex=0,sindex=0,time_shift=10;
function random_vector(){var d;d=Math.floor(6*Math.random())-3;var b=d/500;d=Math.floor(20*Math.random())-5;var g=-.08+d/400;d=Math.floor(6*Math.random())-3;d/=500;var e=Math.sqrt(b*b+g*g+d*d);return{x:b/e,y:g/e,z:d/e}}for(var i=0;i<num;i++){var f=new shell;f.time=-i*time_shift;f.life=0;theSet[i]=f}
function set_position(d,b){cindex=pindex=0;for(var g=!1,e,h,l,m,p,r=0;r<num;r++)if(theSet[r].draw(d,b),g=theSet[r].proceed(),!g){if(0==r%2){level[lindex]=Math.floor(3*Math.random())+2;l=.02*level[lindex];h=level[lindex];p=.005*h;g=0;e=g+launcher_length;var t=random_vector();m=t.x*l;var k=t.y*l;l*=t.z;h=new shell(lx[lindex],ly[lindex],lz[lindex],h,p,g,e,life);h.launcher(lx[lindex],ly[lindex],lz[lindex],m,k,l,g,e,life);h.setColors(175,175,64);h.setTime=0;lastx[lindex]=lx[lindex]+m*launcher_length;lasty[lindex]=
ly[lindex]+(k+h.gravity*launcher_length)*launcher_length;lastz[lindex]=lz[lindex]+l*launcher_length;theSet[sindex]=h;lindex++;3<=lindex&&(lindex=0)}else h=level[findex],g=40,e=g+shell_length,m=8E-4*level[findex],h=new shell(lastx[findex],lasty[findex],lastz[findex],h,m,g,e,life),g=Math.floor(8*Math.random()),g=colors[g],h.setColors(g.red,g.green,g.blue),theSet[sindex]=h,findex++,3<=findex&&(findex=0);sindex++;sindex>=num&&(sindex=0)}};var groundx=4,groundy=4.8,groundz=8,alfa=.9,texture_image=null,DrawingMethod=null,lx=[-3,0,3],ly=[4,4,4],lz=[0,0,0],pindex_ground=0,cindex_ground=0,time=0,timeLoop=800,pattern=0,patternLoop=2,ring_r=.5,ring_g=.5,ring_b=1,graphicLib=null,textureImage=null,texture,img=null,count=0,uniLocation=[];
function create_texture(d,b){uniLocation[0]=b.getUniformLocation(prg_fireworks,"mvpMatrix");uniLocation[1]=b.getUniformLocation(prg_fireworks,"texture");img=new Image;img.onload=function(){var d=b.createTexture();b.bindTexture(b.TEXTURE_2D,d);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,img);b.generateMipmap(b.TEXTURE_2D);b.bindTexture(b.TEXTURE_2D,null);texture=d};img.src=d}
function step_time(d,b){time++;time>timeLoop&&(time=0,pattern++,pattern>=patternLoop&&(pattern=0),2==pattern&&(textureImage=new Image,textureImage.onload=function(){var b=graphicLib.createTexture();graphicLib.bindTexture(graphicLib.TEXTURE_2D,b);graphicLib.texImage2D(graphicLib.TEXTURE_2D,0,graphicLib.RGBA,graphicLib.RGBA,graphicLib.UNSIGNED_BYTE,textureImage);graphicLib.generateMipmap(graphicLib.TEXTURE_2D);graphicLib.bindTexture(graphicLib.TEXTURE_2D,null);texture=b},textureImage.src="hokusai1024.png"));
return 0==time}function set_position_ground(d,b,g){graphicLib=g;switch(pattern){case 0:return color_corners(d,b);case 1:return rings(d,b);case 2:return create_texture("hokusai1024.png",g),hokusai(d,b,g)}}
function color_corners(d,b){cindex_ground=pindex_ground=0;d[pindex_ground++]=groundx;d[pindex_ground++]=groundy;d[pindex_ground++]=groundz;d[pindex_ground++]=-groundx;d[pindex_ground++]=groundy;d[pindex_ground++]=groundz;d[pindex_ground++]=groundx;d[pindex_ground++]=groundy;d[pindex_ground++]=-groundz;d[pindex_ground++]=-groundx;d[pindex_ground++]=groundy;d[pindex_ground++]=-groundz;var g=2*time/timeLoop*2*Math.PI,e=Math.sin(g),g=Math.cos(g);b[cindex_ground++]=.5*e+.5;b[cindex_ground++]=.2;b[cindex_ground++]=
.5*g+.5;b[cindex_ground++]=alfa;b[cindex_ground++]=.5*g+.5;b[cindex_ground++]=.5*e+.5;b[cindex_ground++]=.2;b[cindex_ground++]=alfa;b[cindex_ground++]=.2;b[cindex_ground++]=.5*g+.5;b[cindex_ground++]=.5*e+.5;b[cindex_ground++]=alfa;b[cindex_ground++]=.5*e+.5;b[cindex_ground++]=.5*e+.5;b[cindex_ground++]=.2-.1*g;b[cindex_ground++]=alfa;DrawingMethod=1;return step_time()}
function rings(d,b){cindex_ground=pindex_ground=0;var g=Math.floor(time/10)%3,e=time%10,h=.06*e,l=.1*e;for(i=0;64>=i;i++){var m=2*Math.PI*i/64,p=Math.sin(m),r=Math.cos(m),m=lx[g]+h*p,t=ly[g],k=lz[g]+h*r,p=lx[g]+l*p,n=ly[g],r=lz[g]+l*r,u=ring_r*(10-e)/10;0>u&&(u=0);var w=ring_g*(10-e)/10;0>w&&(w=0);var v=ring_b*(10-e)/10;0>v&&(v=0);d[pindex_ground++]=m;d[pindex_ground++]=t;d[pindex_ground++]=k;b[cindex_ground++]=u;b[cindex_ground++]=w;b[cindex_ground++]=v;b[cindex_ground++]=alfa;d[pindex_ground++]=
p;d[pindex_ground++]=n;d[pindex_ground++]=r;b[cindex_ground++]=u;b[cindex_ground++]=w;b[cindex_ground++]=v;b[cindex_ground++]=alfa}DrawingMethod=1;return step_time()}
function hokusai(d,b,g){cindex_ground=pindex_ground=0;d[pindex_ground++]=groundx;d[pindex_ground++]=groundy;d[pindex_ground++]=groundz;d[pindex_ground++]=-groundx;d[pindex_ground++]=groundy;d[pindex_ground++]=groundz;d[pindex_ground++]=groundx;d[pindex_ground++]=groundy;d[pindex_ground++]=-groundz;d[pindex_ground++]=-groundx;d[pindex_ground++]=groundy;d[pindex_ground++]=-groundz;d=2*time/timeLoop*2*Math.PI;var e=Math.sin(d);d=Math.cos(d);b[cindex_ground++]=.5*e+.5;b[cindex_ground++]=.2;b[cindex_ground++]=
.5*d+.5;b[cindex_ground++]=alfa;b[cindex_ground++]=.5*d+.5;b[cindex_ground++]=.5*e+.5;b[cindex_ground++]=.2;b[cindex_ground++]=alfa;b[cindex_ground++]=.2;b[cindex_ground++]=.5*d+.5;b[cindex_ground++]=.5*e+.5;b[cindex_ground++]=alfa;b[cindex_ground++]=.5*e+.5;b[cindex_ground++]=.5*e+.5;b[cindex_ground++]=.2-.1*d;b[cindex_ground++]=alfa;DrawingMethod=1;g.clearColor(0,0,0,1);g.clearDepth(1);g.clear(g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT);g.bindTexture(g.TEXTURE_2D,h);g.uniform1i(uniLocation[1],0);b=new matIV;
b.identity(b.create());var h=b.identity(b.create()),e=b.identity(b.create()),l=b.identity(b.create());b.identity(b.create());b.lookAt([0,2,5],[0,0,0],[0,1,0],h);b.perspective(45,d.width/d.height,.1,100,e);b.multiply(e,h,l);g.enable(g.DEPTH_TEST);g.depthFunc(g.LEQUAL);g.activeTexture(g.TEXTURE0);var h=null};
